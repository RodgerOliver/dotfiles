#!/bin/bash
# grp - Git Repos Actions

# set only newline as the separator
IFS=$'\n'
# colors
yellow="\e[38;5;226m";
reset="\e[0m";

print_help() {
	echo "grp - Execute actions for git repository inside ~/Repos/"
	echo " "
	echo "Usage:"
	echo "  grp -pl -st"
	echo ""
	echo "  Commands are executed in the order that they are passed as arguments."
	echo "  If no arguments are given it is going to show the status of the repo."
	echo ""
	echo "Options:"
	echo "  -h,  --help                  show help"
	echo "  -st, --status                git status"
	echo "  -fe, --fetch                 git fetch"
	echo "  -ps, --push                  git push"
	echo "  -pl, --pull                  git pull"
	echo "  --exec [command]             execute command for all repos"
	echo "  --path [path]                location of the repos"
	exit 0
}

git_cmd() {
	cmd="git --work-tree=\"$folder_path\" --git-dir=\"$folder_path/.git\" $1"
	eval $cmd
}

GIT_CMD='';
REPOS_PATH="$HOME/Repos/"

for arg in "$@"; do
	case $arg in
		-h|--help)
			print_help
			shift
			;;
		-st|--status)
			GIT_CMD="$GIT_CMD git_cmd status; sleep 1;"
			shift
			;;
		-fe|--fetch)
			GIT_CMD="$GIT_CMD echo 'Fetching repo...'; git_cmd fetch;"
			shift
			;;
		-ps|--push)
			GIT_CMD="$GIT_CMD git_cmd push;"
			shift
			;;
		-pl|--pull)
			GIT_CMD="$GIT_CMD git_cmd pull;"
			shift
			;;
		--exec)
			GIT_CMD=$2
			shift
			;;
		--path)
			REPOS_PATH=$2
			shift
			;;
		*)
			shift
			;;
	esac
done

home_path=$(echo $HOME | sed 's/\//\\\//g')

if [[ -z $GIT_CMD ]]; then
	GIT_CMD="git_cmd status; sleep 1;"
fi

REPOS_PATH=$(echo $REPOS_PATH | sed "s/^~\//$home_path\//")

REPOS_PATH_EX=$(echo $REPOS_PATH | sed 's/\//\\\//g')

a=$(find $REPOS_PATH -maxdepth 1 -type d ! -path $REPOS_PATH);

for folder_path in ${a}; do
	folder=$(echo $folder_path | sed "s/$REPOS_PATH_EX//");
	is_repo=$(ls -a $folder_path | grep -P "^.git$");

	if [[ -z $is_repo ]]; then
		continue;
	fi

	echo -e "${yellow}===================================";
	echo "  $folder";
	echo -e "===================================${reset}";

	eval $GIT_CMD

	echo -e "\n";
done
